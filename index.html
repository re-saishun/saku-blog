<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Scraper Blog Sakurazaka46 (Multi-Mode)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
/* --- Background Image & Centering --- */
body {
    min-height: 100vh;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: url('https://raw.githubusercontent.com/re-saishun/saku-blog/main/5th_TOUR_2025%2013.jpg') center/cover no-repeat fixed;
    position: relative;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body::before {
    content: "";
    position: absolute;
    top:0;
    left:0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
    z-index: 0;
}

.container-scraper {
    position: relative;
    z-index: 1;
    max-width: 900px;
    width: 90%;
    background: rgba(255,255,255,0.95);
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}

h2 { margin-bottom: 20px; color: #0984e3; display: flex; justify-content: center;}
h3 { margin-top: 30px; margin-bottom: 10px; color: #6c5ce7; }

input, select {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    border: 1px solid #dfe6e9;
    border-radius: 8px;
    margin-bottom: 10px;
    transition: all 0.2s;
}

button {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    width: 100%;
    background: #00b894;
    color: #fff;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 20px;
}
button:hover { background: #019875; }

#loadingAI { display: none; margin: 15px 0; text-align: center; }

#finalContent {
    background: #f1f2f6;
    padding: 15px;
    border-radius: 8px;
    overflow-x: auto;
    overflow-y: auto;
    max-height: 200px;
    white-space: pre-wrap;
    word-break: break-word;
    font-size: 14px;
    transition: max-height 0.25s ease;
}

#finalContent.full { max-height: 80vh; }

#fullBtn {
    width: 100%; padding: 8px 12px; background: #6c5ce7; border: none;
    color: white; border-radius: 8px; margin-top: 8px; cursor: pointer;
}
</style>
</head>
<body>

<div class="container-scraper">
  <h2>SAKAMICHI ARTICLE GRABBER</h2>
  
  <input id="urlInput" placeholder="Tempel link blog Sakurazaka46 di sini">
  
  <select id="modePrompt">
      <option value="normal">Mode Normal (Romaji + Indo)</option>
      <option value="belajar">Mode Belajar (Kanji Furigana N5-N4)</option>
  </select>

  <button onclick="scrape()">Ambil Artikel</button>

  <div id="loadingAI">
    <div id="progressText">0%</div>
    <div id="progressBarBg" style="width:100%; background:#ddd; height:8px; border-radius:4px; margin-top:5px;">
        <div id="progressBar" style="width:0%; height:8px; background:#6c5ce7; border-radius:4px;"></div>
    </div>
  </div>

  <div id="resultFinal"></div>
</div>

<script>
let articleLines = [];

async function scrape() {
    const url = document.getElementById("urlInput").value;
    if (!url) return alert("Masukkan URL dulu!");

    document.getElementById("resultFinal").innerHTML = `<div class="text-secondary">Mengambil data...</div>`;

    try {
        const proxyURL = "https://cors-proxy1.vercel.app/api/fetch?url=" + encodeURIComponent(url);
        const res = await fetch(proxyURL);
        const htmlText = await res.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, "text/html");
        const article = doc.querySelector("div.box-article");

        if (!article) {
            document.getElementById("resultFinal").innerHTML = `<div class="text-danger">Tidak menemukan box-article</div>`;
            return;
        }

        let html = article.innerHTML.replace(/src="\/([^"]*)"/g, 'src="https://sakurazaka46.com/$1"');
        articleLines = html.split(/(<br\s*\/?>)/i).filter(l => l.trim().length > 0);

        await buildOutputFinal();
    } catch (err) {
        document.getElementById("resultFinal").innerHTML = `<div class="text-danger">Error: ${err.message}</div>`;
    }
}

async function geminiCall(prompt) {
    try {
        const res = await fetch("https://cors-proxy1.vercel.app/api/gemini", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt })
        });
        const data = await res.json();
        return data?.candidates?.[0]?.content?.parts?.[0]?.text || "(AI-gagal)";
    } catch (err) { return "(AI-gagal)"; }
}

async function buildOutputFinal() {
    const finalOut = [];
    const mode = document.getElementById("modePrompt").value;
    showLoading();

    const tasks = [];
    for (let i = 0; i < articleLines.length; i++) {
        let clean = articleLines[i].replace(/<[^>]+>/g, "").trim();
        
        // MODIFIKASI FILTER UNTUK MODE BELAJAR
        if (mode === "belajar") {
            // Ambil semua teks yang punya huruf/angka (termasuk judul Inggris) tapi abaikan yang cuma simbol 1 karakter
            if (/[a-zA-Z0-9\u3040-\u30ff\u4e00-\u9faf]/.test(clean) && clean.length > 1) {
                tasks.push({ index: i, text: clean });
            }
        } else {
            // Mode Normal tetap filter standar Jepang
            if (/[\u3040-\u30ff\u4e00-\u9faf]/.test(clean)) {
                tasks.push({ index: i, text: clean });
            }
        }
    }

    const batchSize = 15; 
    const resultsMap = {};

    for (let i = 0; i < tasks.length; i += batchSize) {
        const batch = tasks.slice(i, i + batchSize);
        let batchPrompt = "";

        if (mode === "belajar") {
            // MODIFIKASI PROMPT MODE BELAJAR (Lebih to-the-point)
            batchPrompt = `Task: Sakurazaka46 Blog translation for N4 level.
Format: [Index] | [Furigana] | [Translation]
Rules:
1. Rewrite Japanese text with Furigana in brackets for Kanji. e.g. 漢字[かんじ].
2. Keep English/Names as is.
3. Indonesian translation must be simple.
Lines:
${batch.map(t => `${t.index} | ${t.text}`).join('\n')}`;
        } else {
            batchPrompt = `Convert these Japanese lines into ROMAJI and INDONESIAN.
Format: [Index] | [Romaji] | [Translation]
Lines:
${batch.map(t => `${t.index} | ${t.text}`).join('\n')}`;
        }

        try {
            const aiResponse = await geminiCall(batchPrompt);
            const responseLines = aiResponse.split('\n');
            responseLines.forEach(line => {
                const parts = line.split('|');
                if (parts.length >= 3) {
                    // Bersihkan index dari karakter non-angka agar mapping akurat
                    const idx = parts[0].replace(/[^0-9]/g, "").trim();
                    resultsMap[idx] = { val1: parts[1].trim(), val2: parts[2].trim() };
                }
            });
        } catch (e) { console.error(e); }
    }

    for (let i = 0; i < articleLines.length; i++) {
        const original = articleLines[i];
        if (resultsMap[i]) {
            const label1 = (mode === "belajar") ? "READING" : "ROMAJI";
            const merged = `${original}\n<br><span class="romaji">[${label1}] ${resultsMap[i].val1}</span>\n<br><span class="indo">[ID] ${resultsMap[i].val2}</span>`;
            finalOut.push(merged);
        } else {
            finalOut.push(original);
        }
    }

    document.getElementById("resultFinal").innerHTML = `
        <h3 class="text-purple">OUTPUT (${mode.toUpperCase()})</h3>
        <button onclick="copyFinal()" class="btn btn-primary mb-2">Copy Raw</button>
        <div id="outputWrapper">
            <pre id="finalContent" class="mb-1"></pre>
            <button id="fullBtn" onclick="toggleFull()">Full Size</button>
        </div>
    `;

    hideLoading();  
    document.getElementById("finalContent").textContent = finalOut.join("\n");
}

function showLoading() {
    const wrapper = document.getElementById("loadingAI");
    wrapper.style.display = "block";
    let p = 0;
    progressInterval = setInterval(() => {
        if (p >= 95) return;
        p += 5;
        document.getElementById("progressText").textContent = p + "%";
        document.getElementById("progressBar").style.width = p + "%";
    }, 200);
}

function hideLoading() {
    clearInterval(progressInterval);
    document.getElementById("progressText").textContent = "100%";
    document.getElementById("progressBar").style.width = "100%";
    setTimeout(() => { document.getElementById("loadingAI").style.display = "none"; }, 400);
}

function copyFinal() {
    navigator.clipboard.writeText(document.getElementById("finalContent").textContent).then(() => alert("Copied!"));
}

function toggleFull() {
    const box = document.getElementById("finalContent");
    box.classList.toggle("full");
    document.getElementById("fullBtn").textContent = box.classList.contains("full") ? "Kecilkan" : "Full Size";
}

const mdObserver = new MutationObserver(() => {
    const wrapper = document.getElementById("outputWrapper");
    const fullBtn = document.getElementById("fullBtn");
    if (wrapper && fullBtn && !document.getElementById("copyMdBtn")) {
        const btn = document.createElement("button");
        btn.id = "copyMdBtn";
        btn.textContent = "Copy MD";
        btn.style = "width:100%; padding:8px 12px; background:#2d3436; border:none; color:white; border-radius:8px; margin-top:8px; cursor:pointer;";
        btn.onclick = () => {
            const content = document.getElementById("finalContent").textContent;
            const md = content
            .replace(/\n/g, '')
            .replace(/<br\s*\/?>/gi, '\n')
            .replace(/<span class="romaji">\[(.*?)\] (.*?)<\/span>/gi, '_$2_')
            .replace(/<span class="indo">\[ID\] (.*?)<\/span>/gi, '**$1**')
            .replace(/<img[^>]+src="([^">]+)"[^>]*>/gi, '\n![img]($1)\n')
            .replace(/<[^>]+>/g, '')
            .trim();
            navigator.clipboard.writeText(md).then(() => alert("Markdown Copied!"));
        };
        wrapper.insertBefore(btn, fullBtn);
    }
});
mdObserver.observe(document.body, { childList: true, subtree: true });
</script>
</body>
</html>
