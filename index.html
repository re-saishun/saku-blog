<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Scraper Blog Sakurazaka46 (Tag Mentah + Romaji + Terjemahan)</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
    height: 100vh;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f0f0f0;
}

.container-scraper {
    max-width: 900px;
    width: 90%;
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

pre {
    background: #f1f2f6;
    padding: 15px;
    border-radius: 8px;
    overflow-x: auto;
    white-space: pre-wrap;
}
</style>
</head>

<body>
<div class="container-scraper">
    <h2 class="text-center mb-3">SAKAMICHI ARTICLE GRABBER</h2>

    <input id="urlInput" class="form-control mb-2" placeholder="Tempel URL blog Sakurazaka46">
    <button onclick="scrape()" class="btn btn-success w-100 mb-3">Ambil Artikel</button>

    <div id="resultFinal"></div>
</div>

<script>
let articleLines = [];

/* ============================================================
   SCRAPER — menggunakan CORS PROXY VERCEL
============================================================ */
async function scrape() {
    const url = document.getElementById("urlInput").value;
    if (!url) return alert("Masukkan URL!");

    document.getElementById("resultFinal").innerHTML =
        `<div class="text-secondary">Mengambil data...</div>`;

    try {
        const proxyURL =
            "https://cors-proxy1.vercel.app/api/proxy?url=" +
            encodeURIComponent(url);

        const res = await fetch(proxyURL);
        const htmlText = await res.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, "text/html");

        const article = doc.querySelector("div.box-article");

        if (!article) {
            document.getElementById("resultFinal").innerHTML =
                `<div class="text-danger">Gagal menemukan box-article</div>`;
            return;
        }

        // Perbaiki URL gambar
        let html = article.innerHTML.replace(
            /<img\s+src="(\/[^"]*)"/g,
            '<img src="https://sakurazaka46.com$1"'
        );

        // Pecah berdasarkan <br>
        articleLines = html
            .split(/(<br\s*\/?>)/i)
            .map(l => l.trim())
            .filter(l => l.length > 0);

        await buildOutputFinal();

    } catch (err) {
        document.getElementById("resultFinal").innerHTML =
            `<div class="text-danger">ERROR: ${err.message}</div>`;
    }
}

/* ============================================================
   GEMINI (single-request mode)
============================================================ */
async function geminiCall(prompt) {
    try {
        const res = await fetch(
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyD9HGZ6pIVouEgiaTS_dFnVod-kafD0RWk",
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            }
        );

        return await res.json();

    } catch (err) {
        return { error: err.message };
    }
}

/* ============================================================
   BUILD OUTPUT (tag asli + romaji + terjemahan)
============================================================ */
async function buildOutputFinal() {

    let escapedBlocks = [];
    let textBlocks = [];

    for (let line of articleLines) {

        const escaped = line
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");

        const textOnly = line.replace(/<[^>]+>/g, "").trim();
        if (!textOnly) continue;

        escapedBlocks.push(escaped);
        textBlocks.push(textOnly);
    }

    const prompt =
`Berikut daftar kalimat Jepang.
Untuk setiap BARIS:
- Hasilkan ROMAJI secara akurat.
- Hasilkan TERJEMAH ke Bahasa Indonesia.
Format:

ROMAJI: ...
INDO: ...

==========================

` + textBlocks.map((t,i)=>`BARIS ${i+1}: ${t}`).join("\n");

    const ai = await geminiCall(prompt);

    if (!ai.candidates) {
        document.getElementById("resultFinal").innerHTML =
            `<div class='text-danger'>Gagal parse JSON AI.<br>${JSON.stringify(ai)}</div>`;
        return;
    }

    const aiText = ai.candidates[0].content.parts[0].text;

    const blocks = aiText.split(/BARIS \d+:/).slice(1);

    const final = blocks.map((blk, i) => {
        const romaji = (blk.match(/ROMAJI:\s*([\s\S]*?)INDO:/) || ["",""])[1].trim();
        const indo   = (blk.match(/INDO:\s*([\s\S]*)/) || ["",""])[1].trim();

        return `${escapedBlocks[i]}\n${romaji}\n${indo}\n`;
    });

    document.getElementById("resultFinal").innerHTML = `
        <h3 class="text-purple">OUTPUT — Tag Mentah + Romaji + Terjemahan</h3>
        <button class="btn btn-primary mb-3" onclick="copyFinal()">Copy</button>
        <pre id="finalContent">${final.join("\n")}</pre>
    `;
}

/* ============================================================
   COPY
============================================================ */
function copyFinal() {
    const text = document.getElementById("finalContent").textContent;
    navigator.clipboard.writeText(text).then(() => alert("Copied!"));
}
</script>

</body>
</html>
