<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Scraper Blog Sakurazaka46 (Optimized)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
/* --- Fix Background & Overlay --- */
body {
    min-height: 100vh;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    /* Fixed background agar stabil */
    background: url('https://raw.githubusercontent.com/re-saishun/saku-blog/main/5th_TOUR_2025%2013.jpg') center/cover no-repeat fixed;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    position: relative;
    overflow-x: hidden;
}

/* Overlay diperbaiki agar berada di belakang konten tapi di depan gambar */
body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.45);
    z-index: 0;
}

.container-scraper {
    position: relative;
    z-index: 10; /* Pastikan di atas overlay */
    max-width: 900px;
    width: 95%;
    background: rgba(255, 255, 255, 0.95);
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.4);
    margin: 20px 0;
}

h2 { color: #0984e3; text-align: center; font-weight: bold; margin-bottom: 25px; }

input {
    width: 100%;
    padding: 14px;
    border: 2px solid #dfe6e9;
    border-radius: 10px;
    margin-bottom: 10px;
}

button.btn-scrape {
    width: 100%;
    padding: 12px;
    background: #00b894;
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    margin-bottom: 20px;
}

/* --- Progress Bar --- */
#loadingAI { display: none; margin-bottom: 20px; }
.progress { height: 10px; border-radius: 5px; }

/* --- Output Box --- */
#finalContent {
    background: #2d3436;
    color: #dfe6e9;
    padding: 20px;
    border-radius: 10px;
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: 'Courier New', Courier, monospace;
    font-size: 13px;
    line-height: 1.6;
    border: 1px solid #636e72;
}

#finalContent.full { max-height: 80vh; }

.romaji-text { color: #81ecec; font-style: italic; }
.indo-text { color: #fab1a0; font-weight: bold; }

.btn-group-action { display: flex; gap: 10px; margin-top: 10px; flex-direction: column; }
</style>
</head>
<body>

<div class="container-scraper">
    <h2>SAKAMICHI GRABBER V2</h2>
    <input id="urlInput" placeholder="Tempel link blog Sakurazaka46 di sini...">
    <button class="btn-scrape" onclick="scrape()">MULAI PROSES</button>

    <div id="loadingAI">
        <div class="d-flex justify-content-between mb-1">
            <span id="statusLabel" style="font-size: 12px; color: #6c5ce7;">Menghubungi AI...</span>
            <span id="progressText" style="font-size: 12px; font-weight: bold;">0%</span>
        </div>
        <div class="progress">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width: 0%"></div>
        </div>
    </div>

    <div id="resultArea" style="display:none;">
        <h4 id="outputHeader" style="color:#6c5ce7;">Hasil Grab:</h4>
        <pre id="finalContent"></pre>
        
        <div class="btn-group-action" id="actionContainer">
            <button onclick="copyFinal()" class="btn btn-dark">Copy Raw HTML</button>
            <button id="fullBtn" onclick="toggleFull()" class="btn btn-secondary">Zoom Layar</button>
        </div>
    </div>
</div>

<script>
let articleLines = [];

async function scrape() {
    const url = document.getElementById("urlInput").value;
    if (!url) return alert("URL kosong!");

    // Reset view
    document.getElementById("resultArea").style.display = "none";
    document.getElementById("loadingAI").style.display = "block";
    updateProgress(10, "Mengambil data blog...");

    try {
        const proxyURL = "https://cors-proxy1.vercel.app/api/fetch?url=" + encodeURIComponent(url);
        const res = await fetch(proxyURL);
        const htmlText = await res.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, "text/html");
        const article = doc.querySelector("div.box-article");

        if (!article) throw new Error("Konten blog tidak ditemukan!");

        // Fix image paths
        let html = article.innerHTML.replace(/src="\/([^"]*)"/g, 'src="https://sakurazaka46.com/$1"');
        
        // Split by <br> and clean tags for AI processing
        articleLines = html.split(/(<br\s*\/?>)/i).filter(l => l.length > 0);

        await processWithAI();

    } catch (err) {
        alert("Error: " + err.message);
        document.getElementById("loadingAI").style.display = "none";
    }
}

async function processWithAI() {
    updateProgress(30, "Menganalisis teks Jepang...");
    
    const tasks = [];
    for (let i = 0; i < articleLines.length; i++) {
        let cleanText = articleLines[i].replace(/<[^>]+>/g, "").trim();
        if (/[\u3040-\u30ff\u4e00-\u9faf]/.test(cleanText)) {
            tasks.push({ index: i, text: cleanText });
        }
    }

    const batchSize = 10;
    const resultsMap = {};
    
    for (let i = 0; i < tasks.length; i += batchSize) {
        const batch = tasks.slice(i, i + batchSize);
        const progressVal = 30 + Math.floor((i / tasks.length) * 60);
        updateProgress(progressVal, `Menerjemahkan baris ${i} - ${i + batch.length}...`);

        const prompt = `Translate to Romaji & Indonesian. Return only: INDEX | ROMAJI | INDO. 
Lines:
${batch.map(t => `${t.index} | ${t.text}`).join('\n')}`;

        try {
            const aiResp = await geminiCall(prompt);
            aiResp.split('\n').forEach(line => {
                const p = line.split('|').map(s => s.trim());
                if (p.length >= 3) resultsMap[p[0]] = { romaji: p[1], indo: p[2] };
            });
        } catch (e) { console.error("Batch failed", e); }
    }

    // Reconstruction
    let finalHtml = [];
    for (let i = 0; i < articleLines.length; i++) {
        const line = articleLines[i];
        if (resultsMap[i]) {
            const r = resultsMap[i];
            finalHtml.push(`${line}\n<br><span class="romaji">[ROMAJI] ${r.romaji}</span>\n<br><span class="indo">[ID] ${r.indo}</span>`);
        } else {
            finalHtml.push(line);
        }
    }

    updateProgress(100, "Selesai!");
    setTimeout(() => {
        document.getElementById("loadingAI").style.display = "none";
        document.getElementById("resultArea").style.display = "block";
        document.getElementById("finalContent").textContent = finalHtml.join("\n");
    }, 500);
}

async function geminiCall(prompt) {
    const res = await fetch("https://cors-proxy1.vercel.app/api/gemini", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt })
    });
    const data = await res.json();
    return data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
}

function updateProgress(val, label) {
    document.getElementById("progressBar").style.width = val + "%";
    document.getElementById("progressText").textContent = val + "%";
    document.getElementById("statusLabel").textContent = label;
}

function copyFinal() {
    const text = document.getElementById("finalContent").textContent;
    navigator.clipboard.writeText(text).then(() => alert("HTML Ter-copy!"));
}

function toggleFull() {
    const box = document.getElementById("finalContent");
    box.classList.toggle("full");
    document.getElementById("fullBtn").textContent = box.classList.contains("full") ? "Kecilkan" : "Zoom Layar";
}

// Markdown Copy Logic
const mdObserver = new MutationObserver(() => {
    const container = document.getElementById("actionContainer");
    if (container && !document.getElementById("copyMdBtn")) {
        const btn = document.createElement("button");
        btn.id = "copyMdBtn";
        btn.className = "btn btn-outline-primary";
        btn.textContent = "Copy Format Markdown (WP/Blog)";
        btn.onclick = () => {
            const content = document.getElementById("finalContent").textContent;
            const md = content
                .replace(/\n/g, '')
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<span class="romaji">\[ROMAJI\] (.*?)<\/span>/gi, '*$1*')
                .replace(/<span class="indo">\[ID\] (.*?)<\/span>/gi, '**$1**')
                .replace(/<img[^>]+src="([^">]+)"[^>]*>/gi, '\n![]($1)\n')
                .replace(/<[^>]+>/g, '')
                .trim();
            navigator.clipboard.writeText(md).then(() => alert("Markdown Ter-copy!"));
        };
        container.appendChild(btn);
    }
});
mdObserver.observe(document.body, { childList: true, subtree: true });
</script>

</body>
</html>
